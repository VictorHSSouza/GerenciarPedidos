@using Atividade6_Blazor.Shared;
@using Atividade6_Blazor.Services;
@using Atividade6_Blazor.Models;

<div class="p-3">
    <!-- Botão Adicionar Item -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-muted mb-0">
            @if (itens.Any())
            {
                <span>@itens.Count item(s) adicionado(s)</span>
            }
            else
            {
                <span>Nenhum item adicionado</span>
            }
        </h6>
        
        @if (!formulario)
        {
            <button class="btn btn-primary btn-sm" @onclick="NovoItem">
                <i class="bi bi-plus-circle me-1"></i>Adicionar Item
            </button>
        }
    </div>
    
    <!-- Formulário de Item -->
    @if (formulario)
    {
        <div class="mb-4">
            <FormularioItemPedido item="alterarItem" OnAdicionar="AdicionarItem" OnCancelar="CancelarItem"></FormularioItemPedido>
        </div>
    }
    
    <!-- Tabela de Itens -->
    @if (itens.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th scope="col" class="fw-semibold">
                            <i class="bi bi-box me-1"></i>Produto
                        </th>
                        <th scope="col" class="fw-semibold text-center">
                            <i class="bi bi-currency-dollar me-1"></i>Preço Unit.
                        </th>
                        <th scope="col" class="fw-semibold text-center">
                            <i class="bi bi-123 me-1"></i>Qtd.
                        </th>
                        <th scope="col" class="fw-semibold text-center">
                            <i class="bi bi-calculator me-1"></i>Subtotal
                        </th>
                        <th scope="col" class="fw-semibold text-center">
                            <i class="bi bi-gear me-1"></i>Ações
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var i in itens)
                    {
                        <tr class="table-row-hover">
                            <td class="fw-medium">@i.Produto.Nome</td>
                            <td class="text-center text-muted">@i.Produto.Preco.ToString("C")</td>
                            <td class="text-center">
                                <span class="badge bg-secondary">@i.Quantidade</span>
                            </td>
                            <td class="text-center fw-bold text-success">@i.Subtotal.ToString("C")</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-warning" @onclick="() => AtualizarItem(i)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => RemoverItem(i)" title="Remover">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Total Geral:</td>
                        <td class="text-center fw-bold text-success fs-5">
                            @itens.Sum(x => x.Subtotal).ToString("C")
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
    else if (!formulario)
    {
        <div class="text-center py-4 text-muted">
            <i class="bi bi-cart-x display-4 d-block mb-2"></i>
            <p class="mb-0">Nenhum item foi adicionado ao pedido</p>
            <small>Clique em "Adicionar Item" para começar</small>
        </div>
    }
</div>





@code {
    [Parameter] public List<ItemPedido> itens { get; set; }
    private ItemPedido alterarItem = new ItemPedido();

    private bool formulario = false;


    public void NovoItem()
    {
        alterarItem = new ItemPedido();
        formulario = true;
    }


    public void AdicionarItem(ItemPedido i)
    {
        ItemPedido existente = itens.Find(item => item.Produto.Id == i.Produto.Id);
        if (existente == null)
        {
            itens.Add(i);
        }
        else
        {
            i.Quantidade = existente.Quantidade;
            itens[itens.IndexOf(existente)] = i;
            alterarItem = new ItemPedido();
        }
        formulario = false;
    }

    public void AtualizarItem(ItemPedido i)
    {
        alterarItem = i;
        NovoItem();
    }

    public void RemoverItem(ItemPedido i)
    {
        itens.Remove(i);
    }

    public void CancelarItem()
    {
        formulario = false;
    }


}
